var oc={expresionArr:{},ex:{},smdui_expressionSettingPanelEnabled:!1,controlMap:{notUsed:"Not Used",expression:"Expression Controlled",manual:"Manual controlled"},devExpPanel:{}};function sortHeaderElementById(e,t){return t.dataHiTitle-e.dataHiTitle}oc.ex.setExpression=function(e,t){let a=t.expr.el.itemContent;for(;a.firstChild;)a.removeChild(a.firstChild);for(var n=0;n<t.expr.expArrHeader.length;n++)t.expr.expArrHeader[n].classList.remove("ecp_headerContentItemSelected");e.classList.add("ecp_headerContentItemSelected"),a.appendChild(e.dataPanel)},oc.ex.addExpression=function(e,t){let a=t.expr.el.headerContent,n=document.createElement("div");n.classList.add("ecp_headerContentItem"),a.insertBefore(n,t.expr.el.headerNewItemDiv),t.expr.expArrHeader.push(n),n.dataExpId=t.expr.expArrHeader.length;let i=document.createElement("span");i.textContent=t.expr.expArrHeader.length,n.appendChild(i),n.dataHiTitle=t.expr.expArrHeader.length,n.dataHTitleEl=i;let o=document.createElement("i");o.textContent="arrow_upward",o.classList.add("material-icons"),n.appendChild(o),o.onclick=function(e,t){let a=this.dataExpId;if(void 0!==e.children[a-2]&&void 0!==t.expr.expArrHeader[a-2]){let n=e.children[a-2];n.dataExpId++,this.dataExpId--,e.removeChild(this),e.insertBefore(this,n),t.expr.expArrHeader.sort(sortHeaderElementById),n.dataExpression.onchange(),this.dataExpression.onchange(),oc.ex.recalculateExpressionOutput(t)}}.bind(n,a,t);let r=document.createElement("i");r.textContent="arrow_downward",r.classList.add("material-icons"),n.appendChild(r),r.onclick=function(e,t){let a=this.dataExpId;if(void 0!==e.children[a+1]&&void 0!==t.expr.expArrHeader[a]){let n=e.children[a];n.dataExpId--,this.dataExpId++,e.removeChild(this),e.insertBefore(this,e.children[a]),t.expr.expArrHeader.sort(sortHeaderElementById),n.dataExpression.onchange(),this.dataExpression.onchange(),oc.ex.recalculateExpressionOutput(t)}}.bind(n,a,t);let l=document.createElement("i");l.textContent="delete_forever",l.classList.add("material-icons"),n.appendChild(l),l.onclick=function(){a.removeChild(n);for(var e=0;e<this.expr.expArrHeader.length;e++)if(this.expr.expArrHeader[e].dataExpId===n.dataExpId){this.expr.expArrHeader.splice(e,1),oc.ex.recalculateExpressionOutput(this);break}}.bind(t,n,a);let s=document.createElement("div");s.classList.add("ecp_headerContentItem"),n.dataPanel=s,n.dataExpression=new OutputExpressionSelector(s,oc.expressionThree,e),n.dataExpression.onchange=function(e,t){null===e.result?this.dataHTitleEl.textContent=this.dataExpId+" Invalid!":!0===e.state?this.dataHTitleEl.textContent=this.dataExpId+" ON":this.dataHTitleEl.textContent=this.dataExpId+" OFF",oc.ex.recalculateExpressionOutput(t)}.bind(n,n.dataExpression,t),n.dataExpression.expressionFirst.onchange(),oc.ex.setExpression(n,t),n.onclick=function(e){oc.ex.setExpression(this,e)}.bind(n,t)},oc.ex.recalculateExpressionOutput=function(e){let t="";for(var a=0;a<e.expr.expArrHeader.length;a++){let n=e.expr.expArrHeader[a].dataExpression;null!==n.result&&void 0!==n.result&&(t+=n.result,a+1<e.expr.expArrHeader.length&&(t+="|"))}console.log(t),e.expr.expStr=t,e.expr.expStr!==e.expr.expStrOld?e.expr.el.footerContent.style.display="block":e.expr.el.footerContent.style.display="none"},oc.ex.reloadDevExpressionPanel=function(e,t){let a=document.querySelector(".smdui_expressionSettingPanelWrapper");for(;a.firstChild;)a.removeChild(a.firstChild);if(void 0!==oc.devExpPanel[e.serialNumber])a.appendChild(oc.devExpPanel[e.serialNumber]);else{let i=document.createElement("div");i.classList.add("smdui_expressionSettingPanel"),oc.devExpPanel[e.serialNumber]=i,a.appendChild(oc.devExpPanel[e.serialNumber]),i.expr={expStr:null,expStrOld:null,el:{},expArr:[],expArrHeader:[]},i.expr.expArrHeader.length=0,i.expr.expArr.length=0,i.expr.expStrOld=t.expression,i.expr.expStr=t.expression;let o=document.createElement("div");o.classList.add("footerContent"),i.expr.el.footerContent=o;let r=document.createElement("button");r.type="button",o.appendChild(r),r.textContent="save",r.onclick=function(){oc.ex.updateInstructionToDevice(this)}.bind(i);let l=document.createElement("div");l.classList.add("ecp_headerContent"),i.appendChild(l),i.expr.el.headerContent=l;let s=document.createElement("div");if(s.classList.add("itemContent"),i.appendChild(s),i.expr.el.itemContent=s,i.expr.expStr.length>0){let e=i.expr.expStr.split("|");for(var n=0;n<e.length;n++){let t=e[n];oc.ex.addExpression(t,i)}}let p=document.createElement("div");p.classList.add("ecp_headerContentItem"),l.appendChild(p);let d=document.createElement("span");p.appendChild(d),d.textContent="Add Expression",i.expr.el.headerNewItemDiv=p,p.onclick=function(){oc.ex.addExpression("",this)}.bind(i),i.appendChild(o)}console.log("reloadDevExpressionPanel")},oc.ex.updateInstructionToDevice=function(e){devManager.sendDevMessage({instrExt:"expression",instrData:e.expr.expStr},function(t,a){e.expr.expStrOld=e.expr.expStr,e.expr.expStr!==e.expr.expStrOld?e.expr.el.footerContent.style.display="block":e.expr.el.footerContent.style.display="none"})},oc.fetchExpressionTree=function(){devManager.sendDevMessage({instrExt:"getOutputControlMap"},function(e,t){console.log(t),oc.expressionThree=t})},oc.setManualState=function(e){devManager.sendDevMessage({instrExt:"manualControl",instrData:e.toString()},function(t,a){devManager.getSelected().getData().state=e,oc.updateData(devManager.getSelected(),devManager.getSelected().getData())},function(e,t){mainUtils.showWarningMessage(e)},function(e){mainUtils.showWarningMessage("Timout")})},oc.updateControlPanel=function(e){switch(document.querySelectorAll(".controlPanel").forEach(e=>{e.style.display="none"}),e){case"notUsed":case"expression":break;case"manual":document.querySelectorAll(".manualControlPannel").forEach(e=>{e.style.display="flex"})}},oc.dataListExpressionPutLi=function(e,t,a){let n=document.createElement("li");n.textContent=e,!0===a?n.classList.add("smdui_liTrueResult"):!1===a&&n.classList.add("smdui_liFalseResult"),t.appendChild(n)},oc.updateDataExceptionList=function(e,t,a){if(null!=e){let a=document.createElement("ul");!0===e.result?a.classList.add("smdui_ulTrueResult"):!1===e.result&&a.classList.add("smdui_ulFalseResult"),t.appendChild(a),oc.dataListExpressionPutLi("Epression Result: "+e.result,a,e.result);let i=0===e.delay?"Delay: No Delay":e.delay>e.remainingTimeFromDelay?"Remaining time: "+(e.delay-e.remainingTimeFromDelay)+"sec":"Delay Expire";if(oc.dataListExpressionPutLi(i,a),e.dateTimeSchedule){let t="Result="+e.exp.result+" Schedule: ";if(e.dateTimeSchedule.timeSchedule){let a=e.dateTimeSchedule.beginTime,n=e.dateTimeSchedule.endTime;t+=" Time: "+a.hour+":"+a.minute+" - "+n.hour+":"+n.minute}else t+=" Time: [Disabled]";if(e.dateTimeSchedule.weekSchedule){t+=" - Week days: ";for(var n=0;n<e.dateTimeSchedule.weekDays.length;n++)t+=moment().day(e.dateTimeSchedule.weekDays[n]).format("ddd")+" "}else t+=" Week: [Disabled]";oc.dataListExpressionPutLi(t,a,e.dateTimeSchedule.result)}if(void 0!==e.exp)if("PowerService"===e.exp.serviceName)if("available"===e.exp.fieldName){let t="Check Power: "+e.exp.powerName+"[Actual: "+(!0===e.exp.valueOb?"available":"not available")+"]";"eq"===e.exp.equation?!0===e.exp.fixedValueObject?t+=" is Available":t+=" is Not Available":!0===e.exp.fixedValueObject?t+=" is Not Available":t+=" is Available",oc.dataListExpressionPutLi(t,a,e.exp.result)}else{let t="Result="+e.exp.result+" Check Power: "+e.exp.powerName+" "+e.exp.fieldName+" ["+e.exp.valueOb.toFixed(2)+"] ";void 0!==e.exp.compareObject?"PowerService"===e.exp.compareObject.serviceName?t+=" "+expEqMap[e.exp.equation]+" "+e.exp.compareObject.serviceName+" "+e.exp.compareObject.powerName+" "+e.exp.compareObject.fieldName+" ["+e.exp.secondObjValue.toFixed(2)+"]":"EnergyStorageService"===e.exp.compareObject.serviceName&&(t+=" "+expEqMap[e.exp.equation]+" "+e.exp.compareObject.serviceName+" "+e.exp.compareObject.powerName+" "+e.exp.compareObject.fieldName+" ["+e.exp.secondObjValue.toFixed(2)+"]"):t+=" "+expEqMap[e.exp.equation]+" "+(e.exp.fixedValueObject||"Second Object: "+e.exp.secondObjValue),oc.dataListExpressionPutLi(t,a,e.exp.result)}else if("EnergyStorageService"===e.exp.serviceName)if("available"===e.exp.fieldName){let t="Check Storage: "+e.exp.powerName+"[Actual: "+(!0===e.exp.valueOb?"available":"not available")+"]";"eq"===e.exp.equation?!0===e.exp.fixedValueObject?t+=" is Available":t+=" is Not Available":!0===e.exp.fixedValueObject?t+=" is Not Available":t+=" is Available",oc.dataListExpressionPutLi(t,a,e.exp.result)}else{let t="Result="+e.exp.result+("outputStorage"===e.exp.powerObject?" Check Storage BUS: ":" Check Storage: ")+e.exp.powerName+" "+e.exp.fieldName+" ["+e.exp.valueOb.toFixed(2)+"] ";void 0!==e.exp.compareObject?"PowerService"===e.exp.compareObject.serviceName?t+=" "+expEqMap[e.exp.equation]+" "+e.exp.compareObject.serviceName+" "+e.exp.compareObject.powerName+" "+e.exp.compareObject.fieldName+" ["+e.exp.secondObjValue.toFixed(2)+"]":"EnergyStorageService"===e.exp.compareObject.serviceName&&(t+=" "+expEqMap[e.exp.equation]+" "+e.exp.compareObject.serviceName+" "+e.exp.compareObject.powerName+" "+e.exp.compareObject.fieldName+" ["+e.exp.secondObjValue.toFixed(2)+"]"):t+=" "+expEqMap[e.exp.equation]+" "+(e.exp.fixedValueObject||"Second Object: "+e.exp.secondObjValue),oc.dataListExpressionPutLi(t,a,e.exp.result)}else if("ESControlService"===e.exp.serviceName)if("available"===e.exp.fieldName){let t="Check Storage: "+e.exp.powerName+"[Actual: "+(!0===e.exp.valueOb?"available":"not available")+"]";"eq"===e.exp.equation?!0===e.exp.fixedValueObject?t+=" is Available":t+=" is Not Available":!0===e.exp.fixedValueObject?t+=" is Not Available":t+=" is Available",oc.dataListExpressionPutLi(t,a,e.exp.result)}else{let t="Result="+e.exp.result+("outputStorage"===e.exp.powerObject?" Check Storage BUS: ":" Check Storage: ")+e.exp.powerName+" "+e.exp.fieldName+" ["+e.exp.valueOb.toFixed(2)+"] ";void 0!==e.exp.compareObject?"PowerService"===e.exp.compareObject.serviceName?t+=" "+expEqMap[e.exp.equation]+" "+e.exp.compareObject.serviceName+" "+e.exp.compareObject.powerName+" "+e.exp.compareObject.fieldName+" ["+e.exp.secondObjValue.toFixed(0)+"]":"EnergyStorageService"===e.exp.compareObject.serviceName&&(t+=" "+expEqMap[e.exp.equation]+" "+e.exp.compareObject.serviceName+" "+e.exp.compareObject.powerName+" "+e.exp.compareObject.fieldName+" ["+e.exp.secondObjValue.toFixed(0)+"]"):t+=" "+expEqMap[e.exp.equation]+" "+(e.exp.fixedValueObject||"Second Object: "+e.exp.secondObjValue),oc.dataListExpressionPutLi(t,a,e.exp.result)}}void 0!==e.nextLogicalAnd&&(li=document.createElement("li"),ul.appendChild(li),oc.updateDataExceptionList(e.nextLogicalAnd,li,a)),void 0!==e.nextLogicalOr&&(li=document.createElement("li"),a.appendChild(li),oc.updateDataExceptionList(e.nextLogicalOr,li,a))},oc.updateDataException=function(e){if(null!=e){let t=document.querySelector(".expressionActualData");if(t){for(;t.firstChild;)t.removeChild(t.firstChild);let a=document.createElement("span");t.appendChild(a),a.textContent="Expression Tree State.";let n=document.createElement("ol");t.appendChild(n);let i=document.createElement("li");n.appendChild(i),oc.updateDataExceptionList(e,i,n)}}},oc.updateData=function(e,t){if(mainUtils.setHtmlText("actualState",t.state?"Closed":"Open"),mainUtils.setHtmlText("remoteControlled",t.remoteControlled?"YES":"NO"),void 0!==e.getParam()&&void 0!==e.getParam().control){let a="Unknown";!0===t.remoteControlled?a=t.remoteServiceName:void 0!==oc.controlMap[e.getParam().control]&&(a=oc.controlMap[e.getParam().control]),"expression"===e.getParam().control?(oc.updateDataException(t.chainMap),void 0===oc.expressionThree?oc.fetchExpressionTree():!1===oc.smdui_expressionSettingPanelEnabled&&(oc.smdui_expressionSettingPanelEnabled=!0,oc.ex.reloadDevExpressionPanel(e,e.getParam()),document.querySelector(".smdui_expressionSettingPanelWrapper").style.display="flex",document.querySelector(".expressionActualData").style.display="flex")):(oc.smdui_expressionSettingPanelEnabled=!1,document.querySelector(".smdui_expressionSettingPanelWrapper").style.display="none",document.querySelector(".expressionActualData").style.display="none"),oc.updateControlPanel(e.getParam().control),mainUtils.setHtmlText("controlType",a)}mainUtils.setHtmlText("lastSwitchReason",null!==t.lastSwitchReason?t.lastSwitchReason:"Unknown"),mainUtils.setHtmlText("lastSwitchTime",t.lastSwitchTime>0?moment(t.lastSwitchTime).format("MMM-d hh:mm:ss"):"Unknown")},oc.updateParam=function(e,t){console.log(t),"expression"===t.control?void 0===oc.expressionThree?oc.fetchExpressionTree():!1===oc.smdui_expressionSettingPanelEnabled&&(oc.smdui_expressionSettingPanelEnabled=!0,oc.ex.reloadDevExpressionPanel(e,e.getParam()),document.querySelector(".smdui_expressionSettingPanelWrapper").style.display="flex"):(oc.smdui_expressionSettingPanelEnabled=!1,document.querySelector(".smdui_expressionSettingPanelWrapper").style.display="none")},devManager.onSelectedDataReceived(oc.updateData),devManager.onSelectedParamInit(oc.updateParam),devManager.onSelectedChange(function(e){oc.smdui_expressionSettingPanelEnabled=!1,e.connected?(oc.updateData(e,e.getData()),oc.updateParam(e,e.getParam())):mainUtils.setHtmlText("dataValues")}),devManager.onSelectedStatusChange(function(e,t){t&&void 0!==e.getData()?(oc.updateData(e,e.getData()),oc.updateParam(e,e.getParam())):mainUtils.setHtmlText("dataValues")}),$(document).ready(function(){});var expEqMap={lt:"Less than",gt:"Greater than",eq:"Equal",neq:"Not equal"};