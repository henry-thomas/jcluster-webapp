
var bmsRelay={currentIO:0,eqFirstOn:"N/A",eqFirstOff:"N/A",onIoChange:function(a){$(".relayStateLabel").text("-");$(".relayPStateLabel").text("-");$(".bmsPlRelayAutoEqPanel").hide(100);bmsRelay.currentIO=a;bmsRelay.refreshCompParam()},getObjectValue:function(a){var b=bmsRelay.getRelayValueFromObj("socIOObjectFirst");if(a!==1){b=bmsRelay.getRelayValueFromObj("socIOObjectSecond")}var c=devManager.getSelected().getData();try{switch(b){case 0:return Number((c.voltageV*1000).toFixed(0));case 1:return Number((c.cellVoltageVArr.sort()[c.cellVoltageVArr.length-1]*1000).toFixed(0));case 2:return Number((c.cellVoltageVArr.sort()[0]*1000).toFixed(0));case 3:return c.tempGlobal;case 4:return Number((c.capacityAh*1000).toFixed(0));case 5:return Number((c.currentA*1000).toFixed(0))}}catch(d){return" - "}},setChanges:function(e,d){if(devManager.getSelected()!==undefined){var b=devManager.getSelected().getParam().ioParamArrChanges;var a=devManager.getSelected().getParam().ioParamArr;if(a[bmsRelay.currentIO][e]===d){if(b[bmsRelay.currentIO]===undefined){b[bmsRelay.currentIO]={}}delete b[bmsRelay.currentIO][e]}else{if(b[bmsRelay.currentIO]===undefined){b[bmsRelay.currentIO]={}}b[bmsRelay.currentIO][e]=d}var c=Object.keys(b[bmsRelay.currentIO]).length;if(c>0){PF("ioApplyButton").enable()}else{PF("ioApplyButton").disable()}}},getRelayValueFromObj:function(d){var b=devManager.getSelected().getParam();var c=b.ioParamArr[bmsRelay.currentIO];var a=b.ioParamArrChanges[bmsRelay.currentIO];if(c!==undefined){if(a===undefined){a={}}if(a[d]!==undefined){return a[d]}return c[d]}},refreshCompParam:function(){var i=bmsRelay.getRelayValueFromObj("socIOInUse");if(i!==undefined){mu.setSelectOneMenu(i,"rwSocIoMode");bmsRelay.onSocIoModeChange();if(i===1){$(".bmsPlRelayAutoEqPanel").show(500);$(".bmsPlRelayManualEqPanel").hide(500)}else{if(i===3){$(".bmsPlRelayAutoEqPanel").hide(500);$(".bmsPlRelayManualEqPanel").show(500)}else{$(".bmsPlRelayManualEqPanel").hide(500);$(".bmsPlRelayAutoEqPanel").hide(500)}}}var m=bmsRelay.getRelayValueFromObj("socIOReversePolarity");if(m!==undefined){mu.setSelectOneMenu(m,"socIOReversePolarity")}var b=bmsRelay.getRelayValueFromObj("socIOObjectFirstOnLogic");if(b!==undefined){mu.setSelectOneMenu(b,"socIOObjectFirstOnLogicWg")}var e=bmsRelay.getRelayValueFromObj("socIOObjectSecondOnLogic");if(e!==undefined){mu.setSelectOneMenu(e,"socIOObjectSecondOnLogicWg")}var f=bmsRelay.getRelayValueFromObj("socIOObjectFirstOffLogic");if(f!==undefined){mu.setSelectOneMenu(f,"socIOObjectFirstOffLogicWg")}var j=bmsRelay.getRelayValueFromObj("socIOObjectSecondOffLogic");if(j!==undefined){mu.setSelectOneMenu(j,"socIOObjectSecondOffLogicWg")}var d=bmsRelay.getRelayValueFromObj("socIOObjectFirst");if(d!==undefined){mu.setSelectOneMenu(d,"firstCompareObj")}var l=bmsRelay.getRelayValueFromObj("socIOObjectSecond");if(l!==undefined){mu.setSelectOneMenu(l,"secondCompareObj")}var k=bmsRelay.getRelayValueFromObj("socIOObjectDelayOn");if(k!==undefined){mu.setWidgetValue("socIOObjectDelayOnWg",k);mu.setWidgetValue("socIOObjectSDelayOnWg",k)}var c=bmsRelay.getRelayValueFromObj("socIOObjectDelayOff");if(c!==undefined){mu.setWidgetValue("socIOObjectDelayOffWg",c);mu.setWidgetValue("socIOObjectSDelayOffWg",c)}var n=bmsRelay.getRelayValueFromObj("socIOObjectFirstOnLevel");if(n!==undefined){mu.setWidgetValue("socIOObjectFirstOnLevelWg",n)}var o=bmsRelay.getRelayValueFromObj("socIOObjectSecondOnLevel");if(o!==undefined){mu.setWidgetValue("socIOObjectSecondOnLevelWg",o)}var a=bmsRelay.getRelayValueFromObj("socIOObjectFirstOffLevel");if(a!==undefined){mu.setWidgetValue("socIOObjectFirstOffLevelWg",a)}var g=bmsRelay.getRelayValueFromObj("socIOObjectSecondOffLevel");if(g!==undefined){mu.setWidgetValue("socIOObjectSecondOffLevelWg",g)}var h=bmsRelay.getRelayValueFromObj("socIOLogicalOperation");if(h!==undefined){mu.setWidgetValue("socIOLogicalOperationWg",h);if(h===0){$(".bmsPlRelayAutoEqPanelSecond").hide(0)}else{$(".bmsPlRelayAutoEqPanelSecond").show(0)}}},onSocIoModeChange:function(){var b=Number(mu.getWidgetValue("rwSocIoMode"));bmsRelay.setChanges("socIOInUse",b);if(b===1){$(".bmsPlRelayAutoEqPanel").show(500);$(".bmsPlRelayManualEqPanel").hide(500);var c=bmsRelay.getRelayValueFromObj("socIOLogicalOperation");if(c!==undefined){if(c===0){$(".bmsPlRelayAutoEqPanelSecond").hide(0)}else{$(".bmsPlRelayAutoEqPanelSecond").show(0)}}}else{if(b===3){$(".bmsPlRelayAutoEqPanel").hide(500);$(".bmsPlRelayManualEqPanel").show(500)}else{$(".bmsPlRelayManualEqPanel").hide(500);$(".bmsPlRelayAutoEqPanel").hide(500)}}},onSocIOReversePolarity:function(){var b=Number(mu.getWidgetValue("socIOReversePolarity"));bmsRelay.setChanges("socIOReversePolarity",b)},onFirstCompareEqChange:function(){var b=Number(mu.getWidgetValue("firstCompareEq"));bmsRelay.setChanges("socIOObjectFirstCompSeq",b)},onSecondCompareEqChange:function(){var b=Number(mu.getWidgetValue("secondCompareEq"));bmsRelay.setChanges("socIOObjectSecondCompSeq",b)},onSocIOObjectDelayOff:function(c){var b=Number(mu.getWidgetValue(c));bmsRelay.setChanges("socIOObjectDelayOff",b);mu.setWidgetValue("socIOObjectDelayOffWg",b);mu.setWidgetValue("socIOObjectSDelayOffWg",b)},onSocIOObjectDelayOn:function(c){var b=Number(mu.getWidgetValue(c));bmsRelay.setChanges("socIOObjectDelayOn",b);mu.setWidgetValue("socIOObjectDelayOnWg",b);mu.setWidgetValue("socIOObjectSDelayOnWg",b)},onSocIOObjectFirstOffLevel:function(){var b=Number(mu.getWidgetValue("socIOObjectFirstOffLevelWg"));bmsRelay.setChanges("socIOObjectFirstOffLevel",b)},onSocIOObjectSecondOffLevel:function(){var b=Number(mu.getWidgetValue("socIOObjectSecondOffLevelWg"));bmsRelay.setChanges("socIOObjectSecondOffLevel",b)},onSocIOObjectFirstOnLevel:function(){var b=Number(mu.getWidgetValue("socIOObjectFirstOnLevelWg"));bmsRelay.setChanges("socIOObjectFirstOnLevel",b)},onSocIOObjectSecondOnLevel:function(){var b=Number(mu.getWidgetValue("socIOObjectSecondOnLevelWg"));bmsRelay.setChanges("socIOObjectSecondOnLevel",b)},onSocIOObjectFirstOffLogic:function(){var b=Number(mu.getWidgetValue("socIOObjectFirstOffLogicWg"));bmsRelay.setChanges("socIOObjectFirstOffLogic",b)},onSocIOObjectSecondOffLogic:function(){var b=Number(mu.getWidgetValue("socIOObjectSecondOffLogicWg"));bmsRelay.setChanges("socIOObjectSecondOffLogic",b)},onSocIOObjectFirstOnLogic:function(){var b=Number(mu.getWidgetValue("socIOObjectFirstOnLogicWg"));bmsRelay.setChanges("socIOObjectFirstOnLogic",b)},onSocIOObjectSecondOnLogic:function(){var b=Number(mu.getWidgetValue("socIOObjectSecondOnLogicWg"));bmsRelay.setChanges("socIOObjectSecondOnLogic",b)},onSocIOLogicalOperation:function(){var b=Number(mu.getWidgetValue("socIOLogicalOperationWg"));bmsRelay.setChanges("socIOLogicalOperation",b);if(b===0){$(".bmsPlRelayAutoEqPanelSecond").hide(100)}else{$(".bmsPlRelayAutoEqPanelSecond").show(100)}},onFirstObjectChange:function(){var b=Number(mu.getWidgetValue("firstCompareObj"));bmsRelay.setChanges("socIOObjectFirst",b);if(b<3){$(".relayFObjUnit").text("mV")}else{if(b===3){$(".relayFObjUnit").text("deg")}else{if(b===4){$(".relayFObjUnit").text("mAh")}else{if(b===5){$(".relayFObjUnit").text("mA")}}}}},onSecondObjectChange:function(){var b=Number(mu.getWidgetValue("secondCompareObj"));bmsRelay.setChanges("socIOObjectSecond",b);if(b<3){$(".relaySObjUnit").text("mV")}else{if(b===3){$(".relaySObjUnit").text("deg")}else{if(b===4){$(".relaySObjUnit").text("mAh")}else{if(b===5){$(".relaySObjUnit").text("mA")}}}}},calcOutcome:function(c,f){var b=calcFunctionRelay(f,bmsRelay.getRelayValueFromObj("socIOObjectFirstOnLogic"),bmsRelay.getRelayValueFromObj("socIOObjectFirstOnLevel"));var a=calcFunctionRelay(f,bmsRelay.getRelayValueFromObj("socIOObjectFirstOffLogic"),bmsRelay.getRelayValueFromObj("socIOObjectFirstOffLevel"));$(".eqEvalLabelOn").text(b.toString().toUpperCase());$(".eqEvalLabelOff").text(a.toString().toUpperCase());var d=ob=bmsRelay.getRelayValueFromObj("socIOObjectFirstCompSeq");var e=-1;if(b===false&&a===false){$(".relayOutcEqFirst").text("UNCHANGED")}else{if(b===true&&a===true){if(d===0){$(".relayOutcEqFirst").text("ON");e=1}else{$(".relayOutcEqFirst").text("OFF");e=0}}else{if(b===true){$(".relayOutcEqFirst").text("ON");e=1}else{if(a===true){$(".relayOutcEqFirst").text("OFF");e=0}else{$(".relayOutcEqFirst").text("NA");var e=-1}}}}},onDataReveived:function(){var d=devManager.getSelected().getData().ioDataArr[bmsRelay.currentIO];var a=d.state;var b=d.pendingState;$(".relayStateLabel").text(getRelayStateString(a));$(".relayPStateLabel").text(getRelayStateString(b));var c=bmsRelay.getObjectValue(1);$(".relayFObjValue").text(c);bmsRelay.calcOutcome(1,c)},onParamReveived:function(a){var b=a.getParam();if(b.ioParamArr!==undefined){if(b.ioParamArrChanges===undefined){b.ioParamArrChanges=[]}if(b.ioParam===undefined){b.ioParam={}}if(b.ioParam.init===undefined){if(a.selected){bmsRelay.refreshCompParam()}b.ioParam.init=true}}},sendChangesToDevice:function(){},sendBurnIoToDevice:function(){}};var sendRelayIoInstruction=function(){if(devManager.getSelected()!==undefined&&devManager.getSelected().getParam().ioParamArrChanges!==undefined){var a=devManager.getSelected().getParam().ioParamArrChanges[bmsRelay.currentIO];var g=bmsRelay.currentIO;var c=Object.keys(a).length;if(c===0){return}var b;var h;var f;for(var e in a){h=e;b=getMethodFromFieldName(e);f=a[e]}var d={instr:wsm.connectionVar.executeInstr,instrExt:b.toString(),instrData:f.toString(),instrDataExt:g.toString(),devSerialNumber:devManager.getSelected().serialNumber,devModelId:devManager.config.subDevModelId};console.log("send settings");mu.sendWsMessage(d,function(i){mu.showInfoMessage("Success update.",h);delete devManager.getSelected().getParam().ioParamArrChanges[bmsRelay.currentIO][h];devManager.getSelected().getParam().ioParamArr[bmsRelay.currentIO][h]=f;bmsRelay.setChanges(h,f);sendRelayIoInstruction()},function(i){mainUtils.showWarningMessage(i.response.faultMsg,"Instruction execution error!");console.log("Error: "+i.response.faultMsg)},function(){mainUtils.showWarningMessage("Can not refresh Parameters!","timeout");console.log("Timeout")})}};var sendRelayIoInstructionExt=function(a,e){if(devManager.getSelected()!==undefined){var d=1;if(e!=="none"){d=mainUtils.getWidgetValue(e)}var c=bmsRelay.currentIO;var b={instr:wsm.connectionVar.executeInstr,instrExt:a.toString(),instrData:d.toString(),instrDataExt:c.toString(),devSerialNumber:devManager.getSelected().serialNumber,devModelId:devManager.config.subDevModelId};console.log("send settings");mu.sendWsMessage(b,function(f,g){mu.showInfoMessage("Success update.",g)},function(f){mainUtils.showWarningMessage(f.response.faultMsg,"Instruction execution error!");console.log("Error: "+f.response.faultMsg)},function(){mainUtils.showWarningMessage("Can not refresh Parameters!","timeout");console.log("Timeout")})}};var getMethodFromFieldName=function(a){switch(a){case"socIOObjectSecondOnLogic":return"writeSocIOObjectSecondOnLogic";case"socIOObjectSecondOffLevel":return"writeSocIOObjectSecondOffLevel";case"socIOObjectDelayOn":return"writeSocIOObjectDelayOn";case"socIOObjectSecond":return"writeSocIOObjectSecond";case"socIOObjectFirst":return"writeSocIOObjectFirst";case"socIOObjectFirstOffLogic":return"writeSocIOObjectFirstOffLogic";case"socIOObjectFirstOnLevel":return"writeSocIOObjectFirstOnLevel";case"socIOObjectFirstOffLevel":return"writeSocIOObjectFirstOffLevel";case"socIOObjectFirstCompSeq":return"writeSocIOObjectFirstCompSeq";case"socIOObjectSecondCompSeq":return"writeSocIOObjectSecondCompSeq";case"socIOObjectDelayOff":return"writeSocIOObjectDelayOff";case"socIOReversePolarity":return"writeSocIOReversePolarity";case"socIOObjectFirstOnLogic":return"writeSocIOObjectFirstOnLogic";case"socIOLogicalOperation":return"writeSocIOLogicalOperation";case"socIOObjectSecondOffLogic":return"writeSocIOObjectSecondOffLogic";case"socIOInUse":return"writeSocIOInUse";case"socIOObjectSecondOnLevel":return"writeSocIOObjectSecondOnLevel"}};var calcFunctionRelay=function(a,c,b){if(c===0){if(a<b){return true}else{return false}}else{if(a>b){return true}else{return false}}};$(document).ready(function(){devManager.onSelectedDataReceived(function(d){bmsRelay.onDataReveived(d)});devManager.onParamReceived(function(d){bmsRelay.onParamReveived(d)});devManager.onSelectedChange(function(d){bmsRelay.onIoChange(bmsRelay.currentIO)});var c=document.getElementsByClassName("relayButtonSubDiv");for(var b=0;b<c.length;b++){var a=c[b];a.onclick=function(){bmsRelay.onIoChange(Number(this.getElementsByTagName("span")[0].dataset.periodvalue));var e=document.getElementsByClassName("relayButtonSubDiv");for(var d=0;d<e.length;d++){e[d].classList.remove("ui-custom-period-active")}this.classList.add("ui-custom-period-active")}}});var getRelayStateString=function(a){switch(a){case 1:return"AUTO ON";case 2:return"AUTO OFF";case 3:return"MANUAL ON";case 4:return"MANUAL OFF";case 5:return"OVERRIDE OFF";case 6:return"OVERRIDE ON"}return"UNKNOWN: "+a};